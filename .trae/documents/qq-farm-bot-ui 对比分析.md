# qq-farm-bot-ui 项目对比分析报告

## 项目概述

**qq-farm-bot-ui** 是一个功能非常完善的 QQ 农场自动化项目，带有现代化的 Web 管理面板。

### 核心架构
- **主进程 (client.js)**: Worker 管理、日志聚合、配置广播
- **子进程 (worker.js)**: 单账号 worker（统一调度 + 状态同步）
- **HTTP API (admin.js)**: Express 服务 + 面板静态资源
- **前端面板**: 原生 HTML/CSS/JS，无框架依赖

---

## 功能对比表

| 功能类别 | 当前项目 | qq-farm-bot-ui | 可借鉴程度 |
|---------|---------|---------------|-----------|
| **Web 管理面板** | 基础 HTML 页面 | 完整单页应用，多页面导航 | ⭐⭐⭐⭐⭐ |
| **多账号管理** | 支持多账号配置 | 动态增删改查账号，独立进程 | ⭐⭐⭐⭐⭐ |
| **扫码登录** | ❌ | ✅ QQ 小程序扫码登录 | ⭐⭐⭐⭐⭐ |
| **进程管理** | PM2 单进程 | 主进程+Worker 子进程模式 | ⭐⭐⭐⭐ |
| **日志系统** | 简单控制台输出 | 结构化日志，多维度筛选 | ⭐⭐⭐⭐⭐ |
| **主题切换** | ❌ | 深色/浅色主题 | ⭐⭐⭐ |
| **土地可视化** | 简单列表 | 网格化土地展示，作物图片 | ⭐⭐⭐⭐⭐ |
| **好友互动** | 基础功能 | 智能预过滤，静默时段 | ⭐⭐⭐⭐ |
| **数据分析** | ❌ | 种植效率排行榜 | ⭐⭐⭐⭐ |
| **离线提醒** | ❌ | 18+ 推送渠道，重登录链接 | ⭐⭐⭐⭐⭐ |
| **自动重登录** | ❌ | 二维码监听自动更新 Code | ⭐⭐⭐⭐⭐ |
| **任务系统** | ❌ | 成长任务 + 每日任务 | ⭐⭐⭐⭐ |
| **背包管理** | ❌ | 可视化背包，物品图片 | ⭐⭐⭐⭐ |
| **化肥策略** | 基础 | 普通/有机/混合/不施肥 | ⭐⭐⭐ |
| **种植策略** | 固定 | 6种策略（经验/利润优先等）| ⭐⭐⭐⭐ |

---

## 详细功能分析

### 1. Web 管理面板（核心亮点）

**qq-farm-bot-ui 面板特性：**
- 单页应用架构，5个主要页面：概览/个人/好友/账号/设置
- 响应式设计，支持移动端
- 实时数据轮询（3-6秒间隔）
- 账号切换下拉菜单
- 连接状态指示器

**页面详情：**

#### 概览页 (Dashboard)
- 紧凑状态栏：账号信息、运行时长、化肥容器、收藏点、金币/点券、等级经验
- 日志面板：支持多维度筛选（账号/模块/事件/级别/关键词/时间）
- 下次巡查倒计时
- 操作统计（收获/偷菜/浇水/除草/除虫/种植/出售）

#### 个人页 (Personal)
- 成长任务状态 + 进度条
- 每日任务状态
- 土地详情网格（24块土地可视化）
- 背包物品展示
- 一键操作按钮（收获/除草/种植/升级/全收）

#### 好友页 (Friends)
- 好友列表（可展开查看土地）
- 快捷操作（偷菜/浇水/除草/除虫）

#### 账号页 (Accounts)
- 账号卡片网格
- 启动/停止/删除按钮
- 账号操作日志

#### 设置页 (Settings)
- 种植策略选择（6种策略）
- 巡查间隔设置
- 好友静默时段
- 自动控制开关（14个开关）
- 施肥策略
- 管理密码修改
- 下线提醒配置（18+渠道）

---

### 2. 多账号架构（技术亮点）

**当前项目：**
- PM2 启动单个 Node.js 进程
- 多账号在单进程内循环处理

**qq-farm-bot-ui：**
- 主进程负责 HTTP 服务和 Worker 管理
- 每个账号独立子进程（fork）
- 进程间通信（IPC）同步状态和日志
- 单个账号崩溃不影响其他账号

**代码示例：**
```javascript
// 启动 Worker
function startWorker(account) {
    const child = fork(workerPath, [], {
        stdio: ['inherit', 'inherit', 'inherit', 'ipc'],
        env: { ...process.env, FARM_ACCOUNT_ID: String(account.id || '') },
    });
    
    workers[account.id] = {
        process: child,
        status: null,
        logs: [],
        requests: new Map(),
    };
}
```

---

### 3. 扫码登录系统

**功能流程：**
1. 前端请求 `/api/qr/create` 获取登录二维码
2. 用户使用手机 QQ 扫码
3. 前端轮询 `/api/qr/check` 检查状态
4. 登录成功后获取 ticket，换取 authCode
5. 自动创建/更新账号

**技术实现：**
- 基于 QQ 小程序登录协议
- 支持二维码链接和 QQ 直链两种重登录方式
- 自动监听重登录并更新账号 Code

---

### 4. 日志系统

**特性：**
- 结构化日志（时间/标签/消息/元数据）
- 多维度筛选：账号、模块（farm/friend/warehouse/task/system）、事件类型
- 关键词搜索（支持空格分词）
- 时间范围筛选
- 警告级别筛选
- 日志自动轮转（保留1000条）

**事件类型覆盖：**
```javascript
const LOG_EVENT_LABELS = {
    farm_cycle: '农场巡查',
    harvest_crop: '收获作物',
    seed_pick: '选择种子',
    seed_buy: '购买种子',
    plant_seed: '种植种子',
    fertilize: '施加化肥',
    friend_cycle: '好友巡查',
    visit_friend: '访问好友',
    sell_success: '出售成功',
    upgrade_land: '土地升级',
    // ... 更多
};
```

---

### 5. 土地可视化

**当前项目：**
- 简单列表或文本展示

**qq-farm-bot-ui：**
- 网格布局（24块土地）
- 作物图片展示（150+ 种子图片）
- 土地等级颜色区分
- 状态标识（可收获/枯死/生长中）
- 需求提示（需浇水/除草/除虫）

**土地等级样式：**
```css
.land-cell.land-level-0 { background: #2b2f33; } /* 普通 */
.land-cell.land-level-1 { background: #6e5716; } /* 金土地 */
.land-cell.land-level-2 { background: #6b1e1e; } /* 红土地 */
.land-cell.land-level-3 { background: #141414; } /* 黑土地 */
.land-cell.land-level-4 { background: #6f5b16; } /* 紫土地 */
```

---

### 6. 离线提醒系统

**支持的推送渠道（18种）：**
- Webhook（自定义接口）
- Qmsg、Server酱、Push Plus
- 钉钉、企业微信、飞书
- Bark、Telegram、Discord
- go-cqhttp、OneBot
- 等等

**高级特性：**
- 可配置重登录链接（QQ直链/二维码链接）
- 离线超时自动删除账号
- 被踢下线自动提醒

---

### 7. 任务系统

**成长任务：**
- 自动检测任务进度
- 可视化进度条
- 自动领取奖励

**每日任务：**
- 任务列表展示
- 完成状态追踪
- 自动领取

---

### 8. 数据分析

**种植效率排行榜：**
- 按经验效率排序
- 按普通肥经验效率排序
- 按净利润效率排序
- 按普通肥净利润效率排序
- 按等级要求排序

**计算维度：**
- 每小时经验收益
- 每小时金币收益
- 化肥成本计算
- 等级解锁要求

---

### 9. 种植策略系统

**6种策略：**
1. `preferred` - 优先种植指定种子
2. `level` - 最高等级作物
3. `max_exp` - 最大经验/时
4. `max_fert_exp` - 最大普通肥经验/时
5. `max_profit` - 最大净利润/时
6. `max_fert_profit` - 最大普通肥净利润/时

---

### 10. 好友互动优化

**智能预过滤：**
- 只访问有可偷作物或可帮忙的好友
- 减少无效 API 调用

**静默时段：**
- 可设置不打扰时间段（如 23:00-07:00）
- 期间跳过好友互动

**子开关控制：**
- 自动偷菜
- 自动帮忙（浇水/除草/除虫）
- 自动捣乱（放虫草）

---

## 技术实现亮点

### 1. 前端架构
- 无框架依赖（纯原生 JS）
- 模块化 JS 文件组织
- CSS 变量实现主题切换
- 响应式布局（移动端适配）

### 2. 状态管理
- 前端本地状态 + 服务端同步
- 配置版本号机制（避免覆盖）
- 防抖处理（开关控制）

### 3. 性能优化
- 智能轮询间隔（页面可见性检测）
- 请求去重（inFlightRequests）
- 日志虚拟滚动

### 4. 安全设计
- Token 鉴权机制
- 密码 SHA256 存储
- 环境变量支持敏感配置

---

## 可借鉴到当前项目的功能

### 高优先级（建议立即实现）

1. **Web 面板改进**
   - 参考其响应式布局
   - 添加土地网格可视化
   - 改进日志筛选功能

2. **扫码登录**
   - 完全可复用的登录流程
   - 提升用户体验

3. **离线提醒**
   - 集成 pushoo 库
   - 支持多种推送渠道

4. **多账号进程隔离**
   - 参考 Worker 模式
   - 提高稳定性

### 中优先级（可选实现）

5. **主题切换**
   - 已部分实现 MD3，可添加深色模式

6. **任务系统**
   - 成长任务追踪
   - 每日任务自动领取

7. **数据分析**
   - 种植效率计算
   - 排行榜展示

### 低优先级（锦上添花）

8. **背包可视化**
   - 物品图片展示

9. **更多种植策略**
   - 利润优先算法

---

## 文件对应关系

| qq-farm-bot-ui | 当前项目 | 说明 |
|---------------|---------|------|
| client.js | server.js | 主进程入口 |
| src/worker.js | src/FarmConnection.js | 账号逻辑处理 |
| src/admin.js | server.js (API部分) | HTTP API |
| src/store.js | config/ 目录 | 配置持久化 |
| src/farm.js | src/FarmOperations.js | 农场操作 |
| src/friend.js | src/FriendOperations.js | 好友操作 |
| panel/ | public/ | 前端资源 |
| gameConfig/ | - | 游戏数据（种子图片等）|

---

## 总结

qq-farm-bot-ui 是一个非常成熟的产品级项目，其**Web 面板设计**、**多账号进程架构**、**扫码登录**、**离线提醒**等功能都值得当前项目借鉴。

考虑到用户要求：
- ✅ 保持简单 PM2 部署（可不采用 Worker 模式）
- ✅ 兼容现有 API
- ✅ MD3 风格（已部分实现）
- ✅ 最小化第三方依赖
- ✅ 支持 100+ 用户

**建议优先实现：**
1. 改进 Web 面板 UI（参考其布局和交互）
2. 添加扫码登录功能
3. 集成离线提醒
4. 土地可视化展示
