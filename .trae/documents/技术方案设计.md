# QQ农场服务器技术方案设计

## 设计原则

1. **简单优先** - 保持PM2部署，不引入Docker
2. **API兼容** - 现有API保持不变，新增功能通过扩展实现
3. **MD3风格** - 原生CSS实现Material Design 3，不依赖UI库
4. **低依赖** - 仅使用必要的npm包，避免供应链风险
5. **高性能** - 支持100+用户同时在线，内存占用<500MB

---

## 技术选型

### 后端保持
- Express - 已在使用
- WebSocket (ws) - 已在使用，比Socket.io更轻量
- Protobufjs - 已在使用
- 文件存储 - 保持简单，不引入数据库

### 前端方案
- **原生Web Components** - 无框架依赖
- **原生CSS变量** - 实现MD3设计系统
- **原生ES Modules** - 现代浏览器原生支持

### 新增依赖评估
| 包名 | 用途 | 风险 | 决定 |
|------|------|------|------|
| material-symbols | MD3图标 | 低(Google官方) | 可选，可用SVG替代 |
| 无其他依赖 | - | - | 保持现状 |

---

## 架构设计

### 文件结构
```
qq-farm-server/
├── server.js                 # 入口（保持兼容）
├── ecosystem.config.js       # PM2配置（保持）
├── src/
│   ├── AccountManager.js     # 账号管理（优化）
│   ├── FarmManager.js        # 农场管理（优化）
│   ├── FarmConnection.js     # 连接管理（增强）
│   ├── DailyRewards.js       # 【新增】每日奖励系统
│   ├── LandManager.js        # 【新增】土地管理
│   ├── FriendOptimizer.js    # 【新增】好友优化
│   ├── config.js             # 配置
│   ├── proto.js              # Protobuf
│   └── utils.js              # 工具函数
├── public/                   # 【重构】MD3风格WebUI
│   ├── index.html
│   ├── css/
│   │   ├── md3-tokens.css    # MD3设计令牌
│   │   ├── md3-components.css # MD3组件样式
│   │   └── app.css           # 应用样式
│   ├── js/
│   │   ├── components/       # Web Components
│   │   ├── api.js            # API封装
│   │   ├── ws.js             # WebSocket
│   │   └── app.js            # 主应用
│   └── assets/               # 图标等资源
├── data/                     # 数据存储
│   └── accounts.json
└── package.json
```

---

## MD3设计系统实现

### CSS变量（md3-tokens.css）
```css
:root {
  /* 主色调 - 青绿色 */
  --md-sys-color-primary: #006c4c;
  --md-sys-color-on-primary: #ffffff;
  --md-sys-color-primary-container: #89f8c7;
  --md-sys-color-on-primary-container: #002114;
  
  /* 次色调 - 橙色 */
  --md-sys-color-secondary: #4d6357;
  --md-sys-color-on-secondary: #ffffff;
  --md-sys-color-secondary-container: #cfe9d9;
  --md-sys-color-on-secondary-container: #092016;
  
  /* 表面色 */
  --md-sys-color-surface: #fbfdf9;
  --md-sys-color-surface-variant: #dce5dd;
  --md-sys-color-on-surface: #191c1a;
  --md-sys-color-on-surface-variant: #414942;
  
  /* 深色主题 */
  --md-sys-color-surface-dark: #191c1a;
  --md-sys-color-on-surface-dark: #e1e3df;
  
  /* 圆角 */
  --md-sys-shape-corner-small: 4px;
  --md-sys-shape-corner-medium: 8px;
  --md-sys-shape-corner-large: 16px;
  --md-sys-shape-corner-extra-large: 28px;
  
  /* 阴影 */
  --md-sys-elevation-1: 0 1px 3px rgba(0,0,0,0.12);
  --md-sys-elevation-2: 0 2px 6px rgba(0,0,0,0.15);
  --md-sys-elevation-3: 0 4px 12px rgba(0,0,0,0.18);
}
```

### 核心组件
1. **md-button** - 按钮
2. **md-card** - 卡片
3. **md-switch** - 开关
4. **md-dialog** - 对话框
5. **md-snackbar** - 提示条
6. **md-list** - 列表
7. **md-tabs** - 标签页

---

## 性能优化策略

### 1. 内存优化
```javascript
// 限制日志数量
const MAX_LOGS = 200;

// 定期清理断开连接
setInterval(() => {
  farmManager.cleanupStoppedConnections();
}, 60000);

// 使用对象池复用消息对象
const messagePool = [];
```

### 2. 连接优化
```javascript
// 心跳检测优化
const HEARTBEAT_INTERVAL = 30000; // 30秒
const HEARTBEAT_TIMEOUT = 90000;  // 90秒超时

// WebSocket批量广播
const broadcastQueue = [];
setInterval(() => {
  if (broadcastQueue.length > 0) {
    const message = JSON.stringify(broadcastQueue);
    clients.forEach(client => {
      if (client.readyState === WebSocket.OPEN) {
        client.send(message);
      }
    });
    broadcastQueue.length = 0;
  }
}, 100);
```

### 3. 文件存储优化
```javascript
// 延迟写入，批量保存
let saveTimeout = null;
function scheduleSave() {
  if (saveTimeout) clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => {
    fs.writeFileSync(ACCOUNTS_FILE, JSON.stringify(data, null, 2));
  }, 5000); // 5秒后保存
}
```

---

## API扩展设计

### 保持现有API兼容
所有现有API保持不变，新增API通过 `/api/v2/` 前缀

### 新增API
```javascript
// 每日奖励
POST   /api/accounts/:id/daily-rewards/claim    // 领取所有奖励
GET    /api/accounts/:id/daily-rewards/status   // 获取奖励状态

// 土地管理
POST   /api/accounts/:id/lands/:landId/unlock   // 解锁土地
POST   /api/accounts/:id/lands/:landId/upgrade  // 升级土地
GET    /api/accounts/:id/lands                  // 获取土地详情

// 好友优化
GET    /api/accounts/:id/friends/preview        // 好友预览（预筛选）
POST   /api/accounts/:id/friends/optimize       // 执行优化巡查

// 功能开关（扩展）
PUT    /api/accounts/:id/toggles                // 更新功能开关（新增字段）
```

---

## 多人使用架构

### 水平扩展方案
```javascript
// 使用PM2 cluster模式
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'qq-farm-server',
    script: './server.js',
    instances: 'max',        // 使用所有CPU核心
    exec_mode: 'cluster',
    max_memory_restart: '512M',
    env: {
      NODE_ENV: 'production',
      PORT: 3456
    },
    // 负载均衡
    instance_var: 'INSTANCE_ID',
    // 优雅重启
    kill_timeout: 5000,
    listen_timeout: 10000
  }]
};
```

### 会话共享
```javascript
// 使用Redis或文件共享（简单方案）
// 考虑到简单性，使用文件+内存缓存
const sharedState = {
  // 账号状态缓存
  accountStatus: new Map(),
  // 最后更新时间
  lastUpdate: Date.now()
};

// 定期同步到文件
setInterval(() => {
  fs.writeFileSync(STATUS_CACHE_FILE, JSON.stringify(
    Object.fromEntries(sharedState.accountStatus)
  ));
}, 10000);
```

---

## 实施计划

### Phase 1: 核心功能（1-2周）
1. 重构WebUI为MD3风格
2. 实现每日奖励系统（8个功能）
3. 实现土地管理功能

### Phase 2: 优化（1周）
1. 好友智能预筛选
2. 性能优化
3. 多人使用测试

### Phase 3: 完善（3-5天）
1. API文档更新
2. 测试修复
3. 部署验证

---

## 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| MD3实现复杂 | 中 | 中 | 分阶段实现，先核心组件 |
| 100+用户性能问题 | 低 | 高 | 提前做压力测试，预留优化空间 |
| API兼容性问题 | 低 | 高 | 完整回归测试 |
| 依赖安全问题 | 低 | 高 | 最小化依赖，使用lock文件 |

---

## 总结

本方案在保持简单性的前提下，通过原生技术实现MD3风格UI，新增核心功能，并优化性能以支持100+用户。关键决策：

1. **不引入Vue/React** - 使用原生Web Components，零依赖
2. **不引入数据库** - 保持文件存储，简单可靠
3. **不引入Docker** - 保持PM2部署，符合现有习惯
4. **最小化npm依赖** - 仅使用必要的官方包
